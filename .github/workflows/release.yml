name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          libeigen3-dev \
          libopencv-dev \
          libyaml-cpp-dev

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

    - name: Create release package
      run: |
        mkdir -p release/OpenMagFDM-Linux
        cp build/MagFDMsolver release/OpenMagFDM-Linux/
        cp README.md release/OpenMagFDM-Linux/
        cp -r webui release/OpenMagFDM-Linux/
        cp -r sample_config.yaml release/OpenMagFDM-Linux/
        cd release
        tar -czf OpenMagFDM-Linux-x86_64.tar.gz OpenMagFDM-Linux

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-Linux-x86_64
        path: release/OpenMagFDM-Linux-x86_64.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        .\bootstrap-vcpkg.bat

    - name: Install dependencies via vcpkg
      run: |
        .\vcpkg\vcpkg install eigen3:x64-windows
        .\vcpkg\vcpkg install opencv[core,imgcodecs,imgproc]:x64-windows
        .\vcpkg\vcpkg install yaml-cpp:x64-windows

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DCMAKE_TOOLCHAIN_FILE=${{github.workspace}}\vcpkg\scripts\buildsystems\vcpkg.cmake

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j$env:NUMBER_OF_PROCESSORS

    - name: Create release package
      run: |
        New-Item -ItemType Directory -Force -Path release/OpenMagFDM-Windows
        Copy-Item build/${{env.BUILD_TYPE}}/MagFDMsolver.exe release/OpenMagFDM-Windows/
        Copy-Item README.md release/OpenMagFDM-Windows/
        Copy-Item -Recurse webui release/OpenMagFDM-Windows/
        Copy-Item sample_config.yaml release/OpenMagFDM-Windows/

        # Copy necessary DLLs from vcpkg
        $VCPKG_ROOT = "${{github.workspace}}/vcpkg/installed/x64-windows/bin"
        Copy-Item "$VCPKG_ROOT/opencv_core4*.dll" release/OpenMagFDM-Windows/ -ErrorAction SilentlyContinue
        Copy-Item "$VCPKG_ROOT/opencv_imgcodecs4*.dll" release/OpenMagFDM-Windows/ -ErrorAction SilentlyContinue
        Copy-Item "$VCPKG_ROOT/opencv_imgproc4*.dll" release/OpenMagFDM-Windows/ -ErrorAction SilentlyContinue
        Copy-Item "$VCPKG_ROOT/yaml-cpp*.dll" release/OpenMagFDM-Windows/ -ErrorAction SilentlyContinue

        cd release
        Compress-Archive -Path OpenMagFDM-Windows -DestinationPath OpenMagFDM-Windows-x86_64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-Windows-x86_64
        path: release/OpenMagFDM-Windows-x86_64.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake
        brew install eigen
        brew install opencv
        brew install yaml-cpp

    - name: Configure CMake
      run: |
        export PKG_CONFIG_PATH="$(brew --prefix opencv)/lib/pkgconfig:$(brew --prefix yaml-cpp)/lib/pkgconfig:$PKG_CONFIG_PATH"
        cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_PREFIX_PATH="$(brew --prefix opencv);$(brew --prefix yaml-cpp);$(brew --prefix eigen)"

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(sysctl -n hw.ncpu)

    - name: Create release package
      run: |
        mkdir -p release/OpenMagFDM-macOS
        cp build/MagFDMsolver release/OpenMagFDM-macOS/
        cp README.md release/OpenMagFDM-macOS/
        cp -r webui release/OpenMagFDM-macOS/
        cp sample_config.yaml release/OpenMagFDM-macOS/
        cd release
        tar -czf OpenMagFDM-macOS-x86_64.tar.gz OpenMagFDM-macOS

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-macOS-x86_64
        path: release/OpenMagFDM-macOS-x86_64.tar.gz

  build-webui-standalone:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies and create standalone package
      run: |
        cd webui
        npm install
        npm install -g pkg
        mkdir -p ../release

        # Create standalone executables for each platform
        pkg package.json --targets node18-linux-x64 --output ../release/webui-server-linux
        pkg package.json --targets node18-win-x64 --output ../release/webui-server-win.exe
        pkg package.json --targets node18-macos-x64 --output ../release/webui-server-macos

    - name: Create WebUI packages
      run: |
        cd release

        # Linux
        mkdir -p OpenMagFDM-WebUI-Linux
        cp webui-server-linux OpenMagFDM-WebUI-Linux/webui-server
        chmod +x OpenMagFDM-WebUI-Linux/webui-server
        cp -r ../webui/public OpenMagFDM-WebUI-Linux/
        tar -czf OpenMagFDM-WebUI-Linux.tar.gz OpenMagFDM-WebUI-Linux

        # Windows
        mkdir -p OpenMagFDM-WebUI-Windows
        cp webui-server-win.exe OpenMagFDM-WebUI-Windows/webui-server.exe
        cp -r ../webui/public OpenMagFDM-WebUI-Windows/
        zip -r OpenMagFDM-WebUI-Windows.zip OpenMagFDM-WebUI-Windows

        # macOS
        mkdir -p OpenMagFDM-WebUI-macOS
        cp webui-server-macos OpenMagFDM-WebUI-macOS/webui-server
        chmod +x OpenMagFDM-WebUI-macOS/webui-server
        cp -r ../webui/public OpenMagFDM-WebUI-macOS/
        tar -czf OpenMagFDM-WebUI-macOS.tar.gz OpenMagFDM-WebUI-macOS

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-WebUI-Standalone
        path: |
          release/OpenMagFDM-WebUI-Linux.tar.gz
          release/OpenMagFDM-WebUI-Windows.zip
          release/OpenMagFDM-WebUI-macOS.tar.gz

  build-windows-installer:
    runs-on: windows-latest
    needs: [build-windows, build-webui-standalone]

    steps:
    - uses: actions/checkout@v4

    - name: Download Windows build
      uses: actions/download-artifact@v4
      with:
        name: OpenMagFDM-Windows-x86_64
        path: artifacts

    - name: Download WebUI standalone
      uses: actions/download-artifact@v4
      with:
        name: OpenMagFDM-WebUI-Standalone
        path: artifacts-webui

    - name: Extract artifacts
      run: |
        Expand-Archive -Path artifacts/OpenMagFDM-Windows-x86_64.zip -DestinationPath installer-source
        Expand-Archive -Path artifacts-webui/OpenMagFDM-WebUI-Windows.zip -DestinationPath installer-source

    - name: Install NSIS
      run: |
        choco install nsis -y

    - name: Create NSIS installer script
      run: |
        @"
        !define PRODUCT_NAME "OpenMagFDM"
        !define PRODUCT_VERSION "1.0.0"
        !define PRODUCT_PUBLISHER "OpenMagFDM Project"
        !define PRODUCT_WEB_SITE "https://github.com/Marble-GP/OpenMagFDM"

        Name "`${PRODUCT_NAME} `${PRODUCT_VERSION}"
        OutFile "OpenMagFDM-Installer-Windows-x86_64.exe"
        InstallDir "`$PROGRAMFILES64\OpenMagFDM"

        Section "MainSection" SEC01
          SetOutPath "`$INSTDIR"
          File /r "installer-source\OpenMagFDM-Windows\*.*"
          File /r "installer-source\OpenMagFDM-WebUI-Windows\*.*"

          CreateDirectory "`$SMPROGRAMS\OpenMagFDM"
          CreateShortcut "`$SMPROGRAMS\OpenMagFDM\OpenMagFDM Solver.lnk" "`$INSTDIR\MagFDMsolver.exe"
          CreateShortcut "`$SMPROGRAMS\OpenMagFDM\OpenMagFDM WebUI.lnk" "`$INSTDIR\webui-server.exe"
          CreateShortcut "`$DESKTOP\OpenMagFDM.lnk" "`$INSTDIR\MagFDMsolver.exe"
        SectionEnd

        Section "Uninstall"
          Delete "`$SMPROGRAMS\OpenMagFDM\*.*"
          RMDir "`$SMPROGRAMS\OpenMagFDM"
          Delete "`$DESKTOP\OpenMagFDM.lnk"
          RMDir /r "`$INSTDIR"
        SectionEnd
        "@ | Out-File -FilePath installer.nsi -Encoding UTF8

    - name: Build installer
      run: |
        & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-Installer-Windows
        path: OpenMagFDM-Installer-Windows-x86_64.exe

  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-webui-standalone, build-windows-installer]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/OpenMagFDM-Linux-x86_64/OpenMagFDM-Linux-x86_64.tar.gz
          artifacts/OpenMagFDM-Windows-x86_64/OpenMagFDM-Windows-x86_64.zip
          artifacts/OpenMagFDM-macOS-x86_64/OpenMagFDM-macOS-x86_64.tar.gz
          artifacts/OpenMagFDM-WebUI-Standalone/OpenMagFDM-WebUI-Linux.tar.gz
          artifacts/OpenMagFDM-WebUI-Standalone/OpenMagFDM-WebUI-Windows.zip
          artifacts/OpenMagFDM-WebUI-Standalone/OpenMagFDM-WebUI-macOS.tar.gz
          artifacts/OpenMagFDM-Installer-Windows/OpenMagFDM-Installer-Windows-x86_64.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
