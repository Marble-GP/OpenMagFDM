name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          libeigen3-dev \
          libopencv-dev \
          libyaml-cpp-dev

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

    - name: Create release package
      run: |
        mkdir -p release/OpenMagFDM-Linux
        cp build/MagFDMsolver release/OpenMagFDM-Linux/
        cp README.md release/OpenMagFDM-Linux/
        cp -r webui release/OpenMagFDM-Linux/
        cp -r sample_config.yaml release/OpenMagFDM-Linux/
        cd release
        tar -czf OpenMagFDM-Linux-x86_64.tar.gz OpenMagFDM-Linux

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-Linux-x86_64
        path: release/OpenMagFDM-Linux-x86_64.tar.gz

  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          vcpkg_installed
          vcpkg/installed
          vcpkg/packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json') }}-v3
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: Setup vcpkg
      run: |
        # Check if vcpkg repository is properly set up (not just an empty directory from cache)
        if (-not (Test-Path "vcpkg/bootstrap-vcpkg.bat")) {
          Write-Host "vcpkg repository not found or incomplete, setting up..."
          if (Test-Path "vcpkg") {
            Write-Host "Removing incomplete vcpkg directory"
            Remove-Item -Recurse -Force vcpkg
          }
          Write-Host "Cloning vcpkg..."
          git clone https://github.com/Microsoft/vcpkg.git
        } else {
          Write-Host "vcpkg repository exists, skipping clone"
        }

        cd vcpkg

        if (-not (Test-Path "vcpkg.exe")) {
          Write-Host "Bootstrapping vcpkg..."
          .\bootstrap-vcpkg.bat
        } else {
          Write-Host "vcpkg.exe already exists, skipping bootstrap"
        }

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DCMAKE_TOOLCHAIN_FILE="${{github.workspace}}\vcpkg\scripts\buildsystems\vcpkg.cmake"

    - name: Build
      run: |
        $jobs = $env:NUMBER_OF_PROCESSORS
        cmake --build build --config ${{env.BUILD_TYPE}} -j $jobs

    - name: Create release package
      run: |
        New-Item -ItemType Directory -Force -Path release/OpenMagFDM-Windows
        Copy-Item build/${{env.BUILD_TYPE}}/MagFDMsolver.exe release/OpenMagFDM-Windows/
        Copy-Item README.md release/OpenMagFDM-Windows/
        Copy-Item -Recurse webui release/OpenMagFDM-Windows/
        Copy-Item sample_config.yaml release/OpenMagFDM-Windows/

        # Debug: Show directory structure
        Write-Host "=== Workspace structure ==="
        Get-ChildItem "${{github.workspace}}" -Directory | Select-Object Name | Format-Table

        Write-Host "=== Looking for vcpkg directories ==="
        if (Test-Path "${{github.workspace}}/vcpkg_installed") {
          Write-Host "vcpkg_installed exists:"
          Get-ChildItem "${{github.workspace}}/vcpkg_installed" -Recurse -Directory | Where-Object { $_.Name -eq "bin" } | Select-Object FullName
        }
        if (Test-Path "${{github.workspace}}/vcpkg") {
          Write-Host "vcpkg exists, checking installed:"
          Get-ChildItem "${{github.workspace}}/vcpkg" -Recurse -Directory | Where-Object { $_.Name -eq "bin" } | Select-Object FullName
        }
        if (Test-Path "build/vcpkg_installed") {
          Write-Host "build/vcpkg_installed exists:"
          Get-ChildItem "build/vcpkg_installed" -Recurse -Directory | Where-Object { $_.Name -eq "bin" } | Select-Object FullName
        }

        # Find vcpkg installed directory (manifest mode uses vcpkg_installed)
        $VCPKG_BIN_PATHS = @(
          "${{github.workspace}}/vcpkg_installed/x64-windows/bin",
          "${{github.workspace}}/build/vcpkg_installed/x64-windows/bin",
          "${{github.workspace}}/vcpkg/installed/x64-windows/bin"
        )

        $VCPKG_BIN = $null
        foreach ($path in $VCPKG_BIN_PATHS) {
          Write-Host "Checking path: $path"
          if (Test-Path $path) {
            $VCPKG_BIN = $path
            Write-Host "Found vcpkg bin directory: $VCPKG_BIN"
            break
          }
        }

        if (-not $VCPKG_BIN) {
          Write-Host "=== Searching for opencv DLLs recursively ==="
          Get-ChildItem "${{github.workspace}}" -Filter "opencv_core*.dll" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
          Write-Error "Could not find vcpkg bin directory"
          exit 1
        }

        Write-Host "Searching for DLLs in: $VCPKG_BIN"
        Get-ChildItem $VCPKG_BIN -Filter "*.dll" | Select-Object -First 10 | ForEach-Object { Write-Host "  Found: $($_.Name)" }

        # Copy all required DLLs
        Get-ChildItem $VCPKG_BIN -Filter "opencv_*.dll" | Copy-Item -Destination release/OpenMagFDM-Windows/ -Verbose
        Get-ChildItem $VCPKG_BIN -Filter "yaml-cpp.dll" | Copy-Item -Destination release/OpenMagFDM-Windows/ -Verbose

        # Copy OpenCV dependencies (jpeg, png, tiff, zlib, etc.)
        $dependencies = @("jpeg*.dll", "libpng*.dll", "tiff*.dll", "zlib*.dll", "lzma*.dll", "webp*.dll", "libwebp*.dll", "libsharpyuv*.dll")
        foreach ($dep in $dependencies) {
          Get-ChildItem $VCPKG_BIN -Filter $dep -ErrorAction SilentlyContinue | Copy-Item -Destination release/OpenMagFDM-Windows/ -Verbose
        }

        Write-Host "DLLs copied to release package:"
        Get-ChildItem release/OpenMagFDM-Windows -Filter "*.dll" | ForEach-Object { Write-Host "  $($_.Name)" }

        cd release
        Compress-Archive -Path OpenMagFDM-Windows -DestinationPath OpenMagFDM-Windows-x86_64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-Windows-x86_64
        path: release/OpenMagFDM-Windows-x86_64.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install cmake
        brew install eigen
        brew install opencv
        brew install yaml-cpp

    - name: Configure CMake
      run: |
        # Set up CMAKE_PREFIX_PATH for Homebrew packages (works on both Intel and ARM Macs)
        BREW_PREFIX=$(brew --prefix)
        cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_PREFIX_PATH="${BREW_PREFIX};${BREW_PREFIX}/opt/opencv;${BREW_PREFIX}/opt/yaml-cpp;${BREW_PREFIX}/opt/eigen"

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(sysctl -n hw.ncpu)

    - name: Create release package
      run: |
        mkdir -p release/OpenMagFDM-macOS
        cp build/MagFDMsolver release/OpenMagFDM-macOS/
        cp README.md release/OpenMagFDM-macOS/
        cp -r webui release/OpenMagFDM-macOS/
        cp sample_config.yaml release/OpenMagFDM-macOS/
        cd release
        tar -czf OpenMagFDM-macOS-x86_64.tar.gz OpenMagFDM-macOS

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-macOS-x86_64
        path: release/OpenMagFDM-macOS-x86_64.tar.gz

  build-webui-standalone:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies and create standalone package
      run: |
        cd webui
        npm install
        npm install -g pkg
        mkdir -p ../release

        # Create standalone executables for each platform
        pkg package.json --targets node18-linux-x64 --output ../release/webui-server-linux
        pkg package.json --targets node18-win-x64 --output ../release/webui-server-win.exe
        pkg package.json --targets node18-macos-x64 --output ../release/webui-server-macos

    - name: Create WebUI packages
      run: |
        cd release

        # Linux
        mkdir -p OpenMagFDM-WebUI-Linux
        cp webui-server-linux OpenMagFDM-WebUI-Linux/webui-server
        chmod +x OpenMagFDM-WebUI-Linux/webui-server
        cp -r ../webui/public OpenMagFDM-WebUI-Linux/
        tar -czf OpenMagFDM-WebUI-Linux.tar.gz OpenMagFDM-WebUI-Linux

        # Windows
        mkdir -p OpenMagFDM-WebUI-Windows
        cp webui-server-win.exe OpenMagFDM-WebUI-Windows/webui-server.exe
        cp -r ../webui/public OpenMagFDM-WebUI-Windows/
        zip -r OpenMagFDM-WebUI-Windows.zip OpenMagFDM-WebUI-Windows

        # macOS
        mkdir -p OpenMagFDM-WebUI-macOS
        cp webui-server-macos OpenMagFDM-WebUI-macOS/webui-server
        chmod +x OpenMagFDM-WebUI-macOS/webui-server
        cp -r ../webui/public OpenMagFDM-WebUI-macOS/
        tar -czf OpenMagFDM-WebUI-macOS.tar.gz OpenMagFDM-WebUI-macOS

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-WebUI-Standalone
        path: |
          release/OpenMagFDM-WebUI-Linux.tar.gz
          release/OpenMagFDM-WebUI-Windows.zip
          release/OpenMagFDM-WebUI-macOS.tar.gz

  build-windows-installer:
    runs-on: windows-latest
    needs: [build-windows, build-webui-standalone]

    steps:
    - uses: actions/checkout@v4

    - name: Download Windows build
      uses: actions/download-artifact@v4
      with:
        name: OpenMagFDM-Windows-x86_64
        path: artifacts

    - name: Download WebUI standalone
      uses: actions/download-artifact@v4
      with:
        name: OpenMagFDM-WebUI-Standalone
        path: artifacts-webui

    - name: Extract artifacts
      run: |
        Expand-Archive -Path artifacts/OpenMagFDM-Windows-x86_64.zip -DestinationPath installer-source
        Expand-Archive -Path artifacts-webui/OpenMagFDM-WebUI-Windows.zip -DestinationPath installer-source

    - name: Install NSIS
      run: |
        choco install nsis -y

    - name: Create NSIS installer script
      run: |
        @"
        !define PRODUCT_NAME "OpenMagFDM"
        !define PRODUCT_VERSION "1.1.0"
        !define PRODUCT_PUBLISHER "OpenMagFDM Project"
        !define PRODUCT_WEB_SITE "https://github.com/Marble-GP/OpenMagFDM"

        Name "`${PRODUCT_NAME} `${PRODUCT_VERSION}"
        OutFile "OpenMagFDM-Installer-Windows-x86_64.exe"

        # Install to user directory (no admin rights required)
        InstallDir "`$PROFILE\OpenMagFDM"
        RequestExecutionLevel user

        Section "MainSection" SEC01
          SetOutPath "`$INSTDIR"
          File /r "installer-source\OpenMagFDM-Windows\*.*"
          File /r "installer-source\OpenMagFDM-WebUI-Windows\*.*"

          # Create shortcuts
          CreateDirectory "`$SMPROGRAMS\OpenMagFDM"
          CreateShortcut "`$SMPROGRAMS\OpenMagFDM\OpenMagFDM Solver.lnk" "`$INSTDIR\MagFDMsolver.exe" "" "`$INSTDIR\MagFDMsolver.exe" 0 SW_SHOWNORMAL "" "Magnetic Field FDM Solver"
          CreateShortcut "`$SMPROGRAMS\OpenMagFDM\OpenMagFDM WebUI.lnk" "`$INSTDIR\webui-server.exe" "" "`$INSTDIR\webui-server.exe" 0 SW_SHOWNORMAL "" "Web UI for OpenMagFDM"
          CreateShortcut "`$SMPROGRAMS\OpenMagFDM\Uninstall.lnk" "`$INSTDIR\Uninstall.exe"
          CreateShortcut "`$DESKTOP\OpenMagFDM.lnk" "`$INSTDIR\webui-server.exe" "" "`$INSTDIR\webui-server.exe" 0 SW_SHOWNORMAL "" "OpenMagFDM WebUI"

          # Write uninstaller
          WriteUninstaller "`$INSTDIR\Uninstall.exe"

          # Add to Windows Add/Remove Programs
          WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\OpenMagFDM" "DisplayName" "OpenMagFDM"
          WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\OpenMagFDM" "UninstallString" "`$INSTDIR\Uninstall.exe"
          WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\OpenMagFDM" "DisplayVersion" "`${PRODUCT_VERSION}"
          WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\OpenMagFDM" "Publisher" "`${PRODUCT_PUBLISHER}"
          WriteRegStr HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\OpenMagFDM" "URLInfoAbout" "`${PRODUCT_WEB_SITE}"
          WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\OpenMagFDM" "NoModify" 1
          WriteRegDWORD HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\OpenMagFDM" "NoRepair" 1
        SectionEnd

        Section "Uninstall"
          # Remove shortcuts
          Delete "`$SMPROGRAMS\OpenMagFDM\*.*"
          RMDir "`$SMPROGRAMS\OpenMagFDM"
          Delete "`$DESKTOP\OpenMagFDM.lnk"

          # Remove registry entries
          DeleteRegKey HKCU "Software\Microsoft\Windows\CurrentVersion\Uninstall\OpenMagFDM"

          # Remove installation directory
          RMDir /r "`$INSTDIR"
        SectionEnd
        "@ | Out-File -FilePath installer.nsi -Encoding UTF8

    - name: Build installer
      run: |
        & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: OpenMagFDM-Installer-Windows
        path: OpenMagFDM-Installer-Windows-x86_64.exe

  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos, build-webui-standalone, build-windows-installer]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/OpenMagFDM-Linux-x86_64/OpenMagFDM-Linux-x86_64.tar.gz
          artifacts/OpenMagFDM-Windows-x86_64/OpenMagFDM-Windows-x86_64.zip
          artifacts/OpenMagFDM-macOS-x86_64/OpenMagFDM-macOS-x86_64.tar.gz
          artifacts/OpenMagFDM-WebUI-Standalone/OpenMagFDM-WebUI-Linux.tar.gz
          artifacts/OpenMagFDM-WebUI-Standalone/OpenMagFDM-WebUI-Windows.zip
          artifacts/OpenMagFDM-WebUI-Standalone/OpenMagFDM-WebUI-macOS.tar.gz
          artifacts/OpenMagFDM-Installer-Windows/OpenMagFDM-Installer-Windows-x86_64.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
