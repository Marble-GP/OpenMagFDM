# 非線形材料定義の仕様とサンプル
# Nonlinear Material Specification and Examples

# ============================================
# 基本概念 (Basic Concepts)
# ============================================
# mu_r: 微分透磁率 (differential relative permeability)
#       μ_diff = dB/dH (SI単位では μ = μ_r * μ_0)
#
# 定義方法 (Definition Methods):
#   1. STATIC: 定数（線形材料、既存の実装）
#   2. FORMULA: 数式で定義（変数 $H = |H| [A/m]）
#   3. TABLE: 点列で定義 [[H値列], [μ_r値列]]
#
# 内部処理 (Internal Processing):
#   - μ_r(H) → 数値積分 → B(H) テーブル生成
#   - B(H) → 逆補間 → H(B) テーブル生成
#   - 非線形ソルバー: Picard反復 + Anderson加速

# ============================================
# Example 1: 線形材料（既存互換）
# ============================================
materials_linear:
  air:
    rgb: [255, 255, 255]
    mu_r: 1.0           # 定数 → STATIC type
    jz: 0.0
    calc_force: false

  soft_iron_linear:
    rgb: [128, 128, 128]
    mu_r: 1000.0        # 定数 → STATIC type
    jz: 0.0
    calc_force: true

# ============================================
# Example 2: 数式定義（飽和特性）
# ============================================
materials_formula:
  # ガウス関数型飽和（高磁場で mu_r → 1）
  soft_iron_gaussian:
    rgb: [128, 128, 128]
    mu_r: 10000*exp(-$H*$H / 2 / 1e6) + 1
    # $H = |H| [A/m]
    # H=0 で μ_r=10001, H→∞ で μ_r→1
    jz: 0.0
    calc_force: true

  # 双曲線正接型飽和
  soft_iron_tanh:
    rgb: [100, 100, 100]
    mu_r: 1 + 9999 * (1 - tanh($H / 1e5))
    # H=0 で μ_r=10000, H→∞ で μ_r→1
    jz: 0.0
    calc_force: true

  # ローレンツ型（より実用的）
  electrical_steel:
    rgb: [150, 150, 150]
    mu_r: 1 + 5000 / (1 + ($H / 5e4)^2)
    # H=0 で μ_r=5001, H=5e4 で μ_r≈2500
    jz: 0.0
    calc_force: true

# ============================================
# Example 3: 点列定義（実測B-Hカーブから）
# ============================================
materials_table:
  # 電磁鋼板（実測データ例）
  # 1行目: |H| [A/m]（単調増加必須）
  # 2行目: μ_r（単調減少推奨）
  silicon_steel_50A470:
    rgb: [140, 140, 140]
    mu_r:
      - [0, 10, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 50000, 100000]
      - [25000, 24500, 22000, 18000, 12000, 7000, 4000, 2000, 500, 200, 50, 20]
    # 範囲外は最終値で外挿
    # H < 0 → μ_r = 25000
    # H > 100000 → μ_r = 20
    jz: 0.0
    calc_force: true

  # パーマロイ（高透磁率材料）
  permalloy:
    rgb: [180, 180, 200]
    mu_r:
      - [0, 1, 5, 10, 50, 100, 500, 1000, 5000, 10000]
      - [80000, 79500, 75000, 70000, 50000, 35000, 15000, 8000, 2000, 1000]
    jz: 0.0
    calc_force: false

  # フェライト（中程度透磁率、低損失）
  ferrite_MnZn:
    rgb: [160, 100, 100]
    mu_r:
      - [0, 10, 50, 100, 500, 1000, 5000, 10000, 50000]
      - [5000, 4950, 4800, 4500, 3500, 2500, 1200, 600, 100]
    jz: 0.0
    calc_force: false

# ============================================
# Example 4: 混在定義（線形と非線形の共存）
# ============================================
materials_mixed:
  air:
    rgb: [255, 255, 255]
    mu_r: 1.0
    jz: 0.0

  coil:
    rgb: [255, 0, 0]
    mu_r: 1.0
    jz: 1.0e6

  stator_core:
    rgb: [128, 128, 128]
    mu_r:
      - [0, 100, 500, 1000, 5000, 10000, 50000]
      - [8000, 7800, 6500, 5000, 2000, 800, 150]
    jz: 0.0
    calc_force: false

  rotor_core:
    rgb: [100, 100, 100]
    mu_r: 3000*exp(-$H*$H / 2 / 1e6) + 1
    jz: 0.0
    calc_force: true

# ============================================
# 非線形ソルバー設定（オプション）
# ============================================
nonlinear_solver:
  enabled: true               # 非線形材料が定義されている場合は自動有効
  max_iterations: 50          # 最大反復回数
  tolerance: 1e-5             # 収束判定（相対誤差）
  relaxation: 0.7             # 緩和係数（0.5~0.8推奨）
  anderson_depth: 5           # Anderson加速の履歴深さ（0=無効）

  # 診断出力
  verbose: true               # 反復ごとの収束状況を出力
  export_convergence: true    # 収束履歴をCSVで出力

# ============================================
# 検証・警告の設定
# ============================================
validation:
  check_monotonicity: true          # μ_r(H)の単調減少チェック（警告のみ）
  warn_extrapolation: true          # テーブル範囲外での外挿を警告
  table_points_min: 5               # テーブルの最小点数（推奨）
  H_range_check: [0, 1e6]          # 想定されるH範囲 [A/m]（警告用）
