<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenMagFDM Integrated</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            padding: 30px;
        }

        .section h2 {
            color: #495057;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-group input[type="file"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
        }

        textarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 2px solid #ced4da;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            display: none;
        }

        .alert.success {
            display: block;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            display: block;
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .results-list {
            list-style: none;
        }

        .result-item {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-item:hover {
            background: #e9ecef;
        }

        .result-info {
            flex: 1;
        }

        .result-timestamp {
            font-weight: 600;
            color: #667eea;
        }

        .result-files {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§² OpenMagFDM Integrated Environment</h1>
            <p>çµ±åˆç£ç•Œè§£æç’°å¢ƒ - è¨­å®šãƒ»å®Ÿè¡Œãƒ»å¯è¦–åŒ–</p>
            <div style="margin-top: 15px;">
                <a href="dashboard.html" style="display: inline-block; padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 5px; font-weight: 600; transition: background 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    ğŸ“Š ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </a>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('setup')">â‘ è¨­å®š</button>
            <button class="tab" onclick="switchTab('solve')">â‘¡è§£æå®Ÿè¡Œ</button>
            <button class="tab" onclick="switchTab('visualize')">â‘¢å¯è¦–åŒ–</button>
        </div>

        <!-- Tab 1: Setup -->
        <div id="tab-setup" class="tab-content active">
            <div class="section">
                <h2>âš™ï¸ è§£æè¨­å®š</h2>

                <div class="form-group">
                    <label>YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†:</label>
                    <button onclick="loadConfig()">ğŸ“‚ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿</button>
                    <button onclick="saveConfig()" class="secondary">ğŸ’¾ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</button>
                </div>

                <div id="configAlert" class="alert"></div>

                <div class="form-group">
                    <textarea id="configEditor" placeholder="YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ–¼ï¸ æè³ªç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>

                <div class="form-group">
                    <label for="imageUpload">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (PNG, JPG, BMP):</label>
                    <input type="file" id="imageUpload" accept=".png,.jpg,.jpeg,.bmp" onchange="uploadImage()">
                </div>

                <div id="uploadAlert" class="alert"></div>

                <div class="form-group">
                    <label>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒ:</label>
                    <select id="imageList" size="5" style="width: 100%; padding: 10px;">
                        <option>èª­ã¿è¾¼ã¿ä¸­...</option>
                    </select>
                    <button onclick="refreshImageList()" class="secondary" style="margin-top: 10px;">ğŸ”„ æ›´æ–°</button>
                </div>
            </div>
        </div>

        <!-- Tab 2: Solve -->
        <div id="tab-solve" class="tab-content">
            <div class="section">
                <h2>ğŸš€ FDMã‚½ãƒ«ãƒãƒ¼å®Ÿè¡Œ</h2>

                <div class="form-group">
                    <label for="solveImageSelect">æè³ªç”»åƒã‚’é¸æŠ:</label>
                    <select id="solveImageSelect">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                    <button onclick="refreshSolveImages()" class="secondary">ğŸ”„ æ›´æ–°</button>
                </div>

                <div class="form-group">
                    <button onclick="runSolver()" id="runSolverBtn">â–¶ï¸ ã‚½ãƒ«ãƒãƒ¼ã‚’å®Ÿè¡Œ</button>
                </div>

                <div id="solverAlert" class="alert"></div>

                <div id="solverProgress" class="hidden">
                    <div class="spinner"></div>
                    <p style="text-align: center;">è§£æä¸­...</p>
                </div>

                <div id="solverOutput" class="hidden">
                    <h3>å®Ÿè¡Œçµæœ:</h3>
                    <pre id="solverStdout"></pre>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ“Š è§£æçµæœä¸€è¦§</h2>
                <button onclick="refreshResults()">ğŸ”„ çµæœã‚’æ›´æ–°</button>
                <ul id="resultsList" class="results-list">
                    <li>èª­ã¿è¾¼ã¿ä¸­...</li>
                </ul>
            </div>
        </div>

        <!-- Tab 3: Visualize -->
        <div id="tab-visualize" class="tab-content">
            <div class="section">
                <h2>ğŸ“ˆ çµæœã®å¯è¦–åŒ–</h2>

                <div class="form-group">
                    <label for="resultSelect">è§£æçµæœã‚’é¸æŠ:</label>
                    <select id="resultSelect" onchange="loadSelectedResult()">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                    <button onclick="refreshVisualizationResults()" class="secondary">ğŸ”„ æ›´æ–°</button>
                </div>

                <div id="materialImageContainer" class="form-group hidden">
                    <label>æè³ªç”»åƒ (ã‚¹ãƒ©ã‚¤ãƒ‰é ˜åŸŸã‚’ç‚¹ç·šã§è¡¨ç¤º):</label>
                    <canvas id="materialImageCanvas" style="border: 2px solid #ced4da; border-radius: 8px; max-width: 100%; display: block;"></canvas>
                    <p id="imageInfo" style="font-size: 0.9rem; color: #6c757d; margin-top: 5px;"></p>
                </div>

                <div class="form-group">
                    <label for="dx">ãƒ¡ãƒƒã‚·ãƒ¥é–“éš” dx (m):</label>
                    <input type="number" id="dx" value="0.001" step="0.0001" style="width: 200px;">
                </div>

                <div class="form-group">
                    <label for="dy">ãƒ¡ãƒƒã‚·ãƒ¥é–“éš” dy (m):</label>
                    <input type="number" id="dy" value="0.001" step="0.0001" style="width: 200px;">
                </div>

                <div id="stepControls" class="form-group hidden">
                    <label for="stepSlider">ã‚¹ãƒ†ãƒƒãƒ—: <span id="stepValue">0</span> / <span id="totalSteps">0</span></label>
                    <input type="range" id="stepSlider" min="1" max="1" value="1" step="1"
                           style="width: 100%; margin: 10px 0;"
                           oninput="updateStepDisplay(); visualizeStep();">
                    <div style="margin-top: 10px;">
                        <button onclick="playAnimation()" id="playBtn">â–¶ï¸ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ</button>
                        <button onclick="pauseAnimation()" id="pauseBtn" class="hidden">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
                        <button onclick="resetAnimation()">â¹ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
                        <label style="margin-left: 20px;">
                            é€Ÿåº¦:
                            <select id="animSpeed" style="width: 100px;">
                                <option value="2000">é…ã„</option>
                                <option value="500" selected>æ™®é€š</option>
                                <option value="200">é€Ÿã„</option>
                                <option value="100">æœ€é€Ÿ</option>
                            </select>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <button onclick="visualizeResult()" id="visualizeBtn" disabled>ğŸ“Š å¯è¦–åŒ–å®Ÿè¡Œ</button>
                </div>

                <div id="visualizeAlert" class="alert"></div>

                <div id="plots" class="hidden" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                    <div>
                        <h3>ãƒ™ã‚¯ãƒˆãƒ«ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ« Az</h3>
                        <div id="plotAz" style="height: 400px;"></div>
                    </div>
                    <div>
                        <h3>é€ç£ç‡åˆ†å¸ƒ Î¼</h3>
                        <div id="plotMu" style="height: 400px;"></div>
                    </div>
                    <div>
                        <h3>ç£æŸå¯†åº¦ |B|</h3>
                        <div id="plotB" style="height: 400px;"></div>
                    </div>
                    <div>
                        <h3>ç£ç•Œå¼·åº¦ |H|</h3>
                        <div id="plotH" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="integrated.js"></script>
    <script src="material_image.js"></script>
</body>
</html>
